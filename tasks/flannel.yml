---

  - name: stat flannel
    stat: path=/usr/bin/flanneld
    register: flannel_bin

  - name: download flannel
    get_url: "url={{ flannel_bin_url }} dest=/tmp/flannel.tar.gz"
    when: not flannel_bin.stat.exists

  - name: create flannel temp dir
    file: path=/tmp/flannel state=directory
    when: not flannel_bin.stat.exists

  - name: unarchive
    unarchive: src=/tmp/flannel.tar.gz dest=/tmp/flannel remote_src=yes
    when: not flannel_bin.stat.exists

  - name: copy flannel_bin
    copy: src=/tmp/flannel/flanneld dest=/usr/bin/flanneld remote_src=yes
    when: not flannel_bin.stat.exists
    become: true

  - name: cleanup flannel install
    file: path=/tmp/flannel.tar.gz state=absent
    when: not flannel_bin.stat.exists

  - file: path=/tmp/flannel state=absent
    when: not flannel_bin.stat.exists

  - name: flannel systemd conf
    copy: src=flannel.service dest=/etc/systemd/system/flannel.service
    notify: systemd daemon reload
    become: true

  - meta: flush_handlers

  - name: enable flannel service
    service: name=flannel state=started
    become: true



